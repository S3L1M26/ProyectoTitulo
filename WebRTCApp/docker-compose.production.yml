# ===========================================
# DOCKER COMPOSE - PRODUCCIÓN (DigitalOcean)
# ===========================================
#
# SERVICIOS GESTIONADOS POR DIGITALOCEAN (NO en Docker):
# --------------------------------------------------------
# ✅ MySQL Database       → DigitalOcean Managed Database (uso: $DB_HOST)
# ✅ Redis Cache/Queue    → DigitalOcean Managed Redis (uso: $REDIS_HOST)
# ✅ Object Storage (S3)  → DigitalOcean Spaces (uso: $AWS_ENDPOINT)
# ✅ Email Service        → SendGrid SMTP o similar (uso: $MAIL_HOST)
# ✅ SSL/TLS Certificates → DigitalOcean Load Balancer o App Platform
# ✅ CDN                  → DigitalOcean CDN o Cloudflare
# ✅ Backups              → Automáticos en Managed Database
# ✅ Monitoring           → Sentry (uso: $SENTRY_LARAVEL_DSN)
#
# SERVICIOS EN DOCKER (solo app):
# --------------------------------
# ✅ app       → Laravel + Octane + RoadRunner
# ✅ web       → Nginx (reverse proxy a app)
# ✅ queue     → Worker para jobs asíncronos
# ✅ scheduler → Cron tasks (recordatorios de mentorías)
#
# ===========================================

name: webrtcapp-production

services:
  # ===========================================
  # APP: Laravel + RoadRunner + Octane
  # ===========================================
  app:
    build:
      context: .
      dockerfile: Dockerfile
      target: runtime
      args:
        PHP_VERSION: "8.4.3"
        NODE_VERSION: "20"
        INSTALL_XDEBUG: 0
    restart: always
    working_dir: /var/www/html
    command: php artisan octane:start --server=roadrunner --host=0.0.0.0 --port=8000 --workers=4
    
    environment:
      APP_ENV: production
      APP_DEBUG: "false"
      APP_KEY: ${APP_KEY}
      APP_URL: ${APP_URL}
      LOG_CHANNEL: stack
      
      # Database (DigitalOcean Managed MySQL - externo)
      DB_CONNECTION: mysql
      DB_HOST: ${DB_HOST}
      DB_PORT: ${DB_PORT:-3306}
      DB_DATABASE: ${DB_DATABASE}
      DB_USERNAME: ${DB_USERNAME}
      DB_PASSWORD: ${DB_PASSWORD}
      
      # Redis (DigitalOcean Managed Redis - externo)
      CACHE_DRIVER: redis
      SESSION_DRIVER: redis
      QUEUE_CONNECTION: redis
      REDIS_HOST: ${REDIS_HOST}
      REDIS_PORT: ${REDIS_PORT:-6379}
      REDIS_PASSWORD: ${REDIS_PASSWORD}
      
      # Storage (DigitalOcean Spaces - externo)
      FILESYSTEM_DISK: s3
      AWS_ACCESS_KEY_ID: ${AWS_ACCESS_KEY_ID}
      AWS_SECRET_ACCESS_KEY: ${AWS_SECRET_ACCESS_KEY}
      AWS_DEFAULT_REGION: ${AWS_DEFAULT_REGION:-nyc3}
      AWS_BUCKET: ${AWS_BUCKET}
      AWS_ENDPOINT: ${AWS_ENDPOINT}
      AWS_USE_PATH_STYLE_ENDPOINT: "true"
      
      # Mail (SendGrid u otro SMTP - externo)
      MAIL_MAILER: ${MAIL_MAILER:-smtp}
      MAIL_FROM_ADDRESS: ${MAIL_FROM_ADDRESS}
      MAIL_FROM_NAME: ${MAIL_FROM_NAME:-"WebRTC App"}
      MAIL_HOST: ${MAIL_HOST}
      MAIL_PORT: ${MAIL_PORT:-587}
      MAIL_USERNAME: ${MAIL_USERNAME}
      MAIL_PASSWORD: ${MAIL_PASSWORD}
      MAIL_ENCRYPTION: ${MAIL_ENCRYPTION:-tls}
      
      # Monitoring (Sentry - externo)
      SENTRY_LARAVEL_DSN: ${SENTRY_LARAVEL_DSN}
      
      # Timezone (para logs y scheduler)
      TZ: America/Santiago
    
    volumes:
      - ./storage:/var/www/html/storage
      - ./bootstrap/cache:/var/www/html/bootstrap/cache
    
    healthcheck:
      test: ["CMD-SHELL", "pgrep -f 'artisan octane' || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  # ===========================================
  # WEB: Nginx Reverse Proxy
  # ===========================================
  web:
    image: nginx:1.27-alpine
    restart: always
    ports:
      - "80:80"
    
    volumes:
      - ./docker/nginx/production.conf:/etc/nginx/conf.d/default.conf:ro
      - ./public:/var/www/html/public:ro
    
    depends_on:
      app:
        condition: service_healthy
    
    healthcheck:
      test: ["CMD-SHELL", "wget --quiet --tries=1 --spider http://localhost/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3

  # ===========================================
  # QUEUE: Worker para Jobs Asíncronos
  # ===========================================
  queue:
    build:
      context: .
      dockerfile: Dockerfile
      target: runtime
      args:
        PHP_VERSION: "8.4.3"
        NODE_VERSION: "20"
        INSTALL_XDEBUG: 0
    restart: always
    working_dir: /var/www/html
    command: php artisan queue:work redis --queue=emails,default --sleep=3 --tries=3 --timeout=90 --max-jobs=100 --max-time=3600 --verbose
    
    environment:
      APP_ENV: production
      APP_DEBUG: "false"
      APP_KEY: ${APP_KEY}
      LOG_CHANNEL: stack
      TZ: America/Santiago
      
      # Database
      DB_CONNECTION: mysql
      DB_HOST: ${DB_HOST}
      DB_PORT: ${DB_PORT:-3306}
      DB_DATABASE: ${DB_DATABASE}
      DB_USERNAME: ${DB_USERNAME}
      DB_PASSWORD: ${DB_PASSWORD}
      
      # Redis
      CACHE_DRIVER: redis
      QUEUE_CONNECTION: redis
      REDIS_HOST: ${REDIS_HOST}
      REDIS_PORT: ${REDIS_PORT:-6379}
      REDIS_PASSWORD: ${REDIS_PASSWORD}
      
      # Mail
      MAIL_MAILER: ${MAIL_MAILER:-smtp}
      MAIL_FROM_ADDRESS: ${MAIL_FROM_ADDRESS}
      MAIL_FROM_NAME: ${MAIL_FROM_NAME:-"WebRTC App"}
      MAIL_HOST: ${MAIL_HOST}
      MAIL_PORT: ${MAIL_PORT:-587}
      MAIL_USERNAME: ${MAIL_USERNAME}
      MAIL_PASSWORD: ${MAIL_PASSWORD}
      MAIL_ENCRYPTION: ${MAIL_ENCRYPTION:-tls}
      
      # Monitoring
      SENTRY_LARAVEL_DSN: ${SENTRY_LARAVEL_DSN}
    
    volumes:
      - ./storage:/var/www/html/storage
      - ./bootstrap/cache:/var/www/html/bootstrap/cache
    
    depends_on:
      app:
        condition: service_healthy

  # ===========================================
  # SCHEDULER: Tareas Programadas (Cron)
  # Ejecuta: mentorias:enviar-recordatorios (09:00 AM diario)
  # ===========================================
  scheduler:
    build:
      context: .
      dockerfile: Dockerfile
      target: runtime
      args:
        PHP_VERSION: "8.4.3"
        NODE_VERSION: "20"
        INSTALL_XDEBUG: 0
    restart: always
    working_dir: /var/www/html
    command: sh -c "while true; do php artisan schedule:run --verbose --no-interaction; sleep 60; done"
    
    environment:
      APP_ENV: production
      APP_DEBUG: "false"
      APP_KEY: ${APP_KEY}
      LOG_CHANNEL: stack
      TZ: America/Santiago
      
      # Database
      DB_CONNECTION: mysql
      DB_HOST: ${DB_HOST}
      DB_PORT: ${DB_PORT:-3306}
      DB_DATABASE: ${DB_DATABASE}
      DB_USERNAME: ${DB_USERNAME}
      DB_PASSWORD: ${DB_PASSWORD}
      
      # Redis
      CACHE_DRIVER: redis
      REDIS_HOST: ${REDIS_HOST}
      REDIS_PORT: ${REDIS_PORT:-6379}
      REDIS_PASSWORD: ${REDIS_PASSWORD}
      
      # Mail
      MAIL_MAILER: ${MAIL_MAILER:-smtp}
      MAIL_FROM_ADDRESS: ${MAIL_FROM_ADDRESS}
      MAIL_FROM_NAME: ${MAIL_FROM_NAME:-"WebRTC App"}
      MAIL_HOST: ${MAIL_HOST}
      MAIL_PORT: ${MAIL_PORT:-587}
      MAIL_USERNAME: ${MAIL_USERNAME}
      MAIL_PASSWORD: ${MAIL_PASSWORD}
      MAIL_ENCRYPTION: ${MAIL_ENCRYPTION:-tls}
      
      # Monitoring
      SENTRY_LARAVEL_DSN: ${SENTRY_LARAVEL_DSN}
    
    volumes:
      - ./storage:/var/www/html/storage
      - ./bootstrap/cache:/var/www/html/bootstrap/cache
    
    depends_on:
      app:
        condition: service_healthy

